---
services:
  web:
    profiles:
      - sql
      - mongo
      - datomic-peer
      - datomic-client
      - all
    image: multi-money-web
    build:
      context: ../../
    command: java clojure.main -m multi-money.server
    ports:
      - 3010:3000
    env_file:
      - .env
    environment:
      CLASSPATH: /opt/multi-money/config:/opt/multi-money/multi-money.jar
      DATOMIC_STORAGE_URI: datomic:sql://${DATOMIC_DB_NAME}?jdbc:postgresql://${SQL_HOST}:5432/datomic?user=${SQL_APP_USER}&password=${SQL_APP_PASSWORD}
    depends_on:
      datomic-peer-server:
        condition: service_started # don't know why the health check is failing
      mongo:
        condition: service_healthy
    volumes:
      - ./config:/opt/multi-money/config
      - maven-data:/root/.m2
